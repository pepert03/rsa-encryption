<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoChat - Multi-Chat P2P</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        /* DARK THEME AND FULL SCREEN */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #0e1621; color: #f5f5f5; height: 100vh; display: flex; overflow: hidden; }
        .app-container { display: flex; width: 100vw; height: 100vh; background: #0e1621; }
        
        .sidebar { width: 350px; background: #17212b; border-right: 1px solid #000; display: flex; flex-direction: column; z-index: 2; flex-shrink: 0; }
        .sidebar-header { background: #17212b; padding: 15px 20px; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: space-between; gap: 10px; border-bottom: 1px solid #000; }
        .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; }
        
        .section-title { font-size: 13px; color: #5288c1; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 15px; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 13px; color: #7a8b9a; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid transparent; border-radius: 8px; font-family: monospace; font-size: 14px; background: #242f3d; color: #fff; outline: none; transition: border 0.2s; }
        .input-group input:focus { border-color: #5288c1; }
        .input-group input.private-key { color: #ff8a8a; }
        .divider { height: 1px; background: #000; margin: 15px 0; }
        
        /* Contact list */
        .user-list { display: flex; flex-direction: column; gap: 5px; }
        .user-card { background: transparent; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 10px; position: relative;}
        .user-card:hover { background: #242f3d; }
        .user-card.active { background: #2b5278; }
        .user-avatar { width: 40px; height: 40px; background: #5288c1; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; color: white; position: relative; font-size: 16px; flex-shrink: 0;}
        .online-dot { width: 12px; height: 12px; background: #76c489; border: 2px solid #242f3d; border-radius: 50%; position: absolute; bottom: -2px; right: -2px; }
        .user-info { flex: 1; overflow: hidden; }
        .user-name { font-weight: bold; font-size: 15px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; color: #fff; }
        .user-n { font-size: 12px; color: #7aa1c9; font-family: monospace; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; margin-top: 2px; }
        .user-card.active .user-n { color: #a1c8ed; }

        .btn-announce { width: 100%; padding: 10px; background: #5288c1; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; transition: background 0.3s; }
        .btn-announce:hover { background: #4676a9; }
        
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #0e1621; position: relative; }
        .chat-area::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M0 0h20v20H0V0zm10 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" fill="%23ffffff" fill-opacity="0.02" fill-rule="evenodd"/%3E%3C/svg%3E'); z-index: 0; }
        
        .chat-header { background: #17212b; padding: 12px 20px; border-bottom: 1px solid #000; display: flex; flex-direction: column; z-index: 1; }
        .chat-title { font-weight: bold; font-size: 16px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .chat-subtitle { font-size: 13px; color: #7a8b9a; margin-top: 2px; }
        
        .chat-history { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; z-index: 1; }
        
        /* Burbujas */
        .msg { max-width: 65%; padding: 8px 12px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .msg.sent { align-self: flex-end; background: #2b5278; border-radius: 12px 12px 4px 12px; color: #fff; }
        .msg.received { align-self: flex-start; background: #182533; border-radius: 12px 12px 12px 4px; color: #fff; }
        .msg.global { align-self: center; background: rgba(0,0,0,0.3); color: #7a8b9a; font-size: 12px; font-family: monospace; border-radius: 16px; box-shadow: none; text-align: center; max-width: 80%; padding: 6px 14px; }
        .msg-meta { font-size: 11px; color: #7aa1c9; text-align: right; margin-top: 4px; float: right; margin-left: 10px; }
        .msg.received .msg-meta { color: #5b7185; }
        
        .chat-input-area { background: #17212b; padding: 10px 20px; display: flex; gap: 10px; align-items: center; z-index: 1; }
        .chat-input-area input { flex: 1; border: none; outline: none; font-size: 15px; padding: 12px; background: #242f3d; color: white; border-radius: 8px; }
        .btn-send { background: #5288c1; color: white; border: none; border-radius: 50%; width: 46px; height: 46px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
        .btn-send:hover { background: #4676a9; }
        .btn-send svg { width: 20px; height: 20px; fill: currentColor; margin-left: 4px; }
        .btn-send:disabled { background: #3b4b5c; color: #7a8b9a; cursor: not-allowed; }
        
        #py-status { font-size: 12px; background: #3b2d18; color: #dcb362; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <span>‚öôÔ∏è RSA Chat</span>
            <span id="py-status">Loading Python... üêç</span>
        </div>
        <div class="sidebar-content">
            <div class="section-title" style="margin-top: 0;">My Public Profile</div>
            <div class="input-group">
                <input type="text" id="my-name" placeholder="Type your public name..." style="font-family: inherit; font-size: 15px; font-weight: bold;">
                <button id="btn-announce" class="btn-announce" onclick="toggleOnlineStatus()">Go online</button>
            </div>

            <details style="margin-bottom: 15px;">
                <summary style="color: #7a8b9a; font-size: 13px; cursor: pointer; margin-bottom: 5px;">Show my generated RSA keys</summary>
                <div class="input-group" style="margin-top: 10px;">
                    <label>Public Key 'n'</label>
                    <input type="text" id="my-n" readonly placeholder="Waiting for Python...">
                </div>
                <div class="input-group">
                    <label>Public Key 'e'</label>
                    <input type="text" id="my-e" readonly placeholder="Waiting for Python...">
                </div>
                <div class="input-group">
                    <label>Private Key 'd'</label>
                    <input type="text" id="my-d" class="private-key" readonly placeholder="Waiting for Python...">
                </div>
            </details>
            
            <details style="margin-bottom: 15px;">
                <summary style="color: #7a8b9a; font-size: 13px; cursor: pointer;">Advanced Settings (Manual Recipient)</summary>
                <div class="input-group" style="margin-top: 10px;">
                    <input type="text" id="rec-n" placeholder="Recipient n">
                </div>
                <div class="input-group">
                    <input type="text" id="rec-e" placeholder="Recipient e">
                </div>
                <div class="input-group">
                    <label>Global padding 'p'</label>
                    <input type="number" id="pad-p" value="0">
                </div>
            </details>

            <div class="divider"></div>
            
            <div class="section-title">Chats and Users <span id="online-count" style="float: right; color: #76c489;"></span></div>
            <div id="user-list" class="user-list">
                </div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-title" id="chat-title-text">Global P2P Network <span id="ws-status" style="font-size: 12px; margin-left: 10px;">üî¥</span></div>
            <div class="chat-subtitle" id="chat-subtitle-text">Encrypted network traffic monitor</div>
        </div>
        
        <div class="chat-history" id="chat-history">
            </div>
        
        <div class="chat-input-area">
            <input type="text" id="message-input" placeholder="Select a user to send messages..." onkeypress="handleEnter(event)" disabled>
            <button id="send-btn" class="btn-send" onclick="sendCustomMessage()" title="Send" disabled>
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </div>
    </div>
</div>

<script type="py">
import random
from math import isqrt
from typing import List, Optional, Tuple
from js import window
from pyodide.ffi import to_js

def bezout(a: int, b: int) -> Tuple[int, int, int]:
    if a == 0 and b == 0: return 0, 0, 0
    old_r, r = a, b
    old_x, x = 1, 0
    old_y, y = 0, 1
    while r != 0:
        q = old_r // r
        old_r, r = r, old_r - q * r
        old_x, x = x, old_x - q * x
        old_y, y = y, old_y - q * y
    return int(old_r), int(old_x), int(old_y)

def mod_inverse(value: int, modulus: int) -> Optional[int]:
    g, x, _y = bezout(value, modulus)
    if g != 1: return None
    return x % modulus

def mod_pow(base: int, exponent: int, modulus: int) -> int:
    if modulus == 0: raise ValueError("modulus must be non-zero")
    if exponent < 0:
        base = mod_inverse(base, modulus)
        if base is None: raise ValueError("base has no modular inverse for negative exponent")
        exponent = -exponent
    return pow(base % modulus, exponent, modulus)

def gcd(a: int, b: int) -> int:
    x, y = abs(a), abs(b)
    while y != 0: x, y = y, x % y
    return x

def are_coprime(a: int, b: int) -> bool:
    return gcd(a, b) == 1

def is_prime(n: int) -> bool:
    if n < 2: return False
    if n == 2: return True
    if n % 2 == 0: return False
    limit = isqrt(n)
    for candidate in range(3, limit + 1, 2):
        if n % candidate == 0: return False
    return True

def list_primes(start: int, end: int) -> List[int]:
    if end <= 2: return []
    sieve = [1 for _ in range(end)]
    sieve[0] = 0
    if end > 1: sieve[1] = 0
    limit = int(end**0.5)
    candidate = 2
    while candidate <= limit:
        if sieve[candidate] == 0:
            candidate += 1
            continue
        multiple = candidate * 2
        while multiple < end:
            sieve[multiple] = 0
            multiple += candidate
        candidate += 1
    primes: List[int] = []
    for value in range(max(2, start), end):
        if sieve[value] == 1: primes.append(value)
    return primes

def generate_keys(min_prime: int, max_prime: int) -> Tuple[int, int, int]:
    primes = list_primes(min_prime, max_prime)
    p1 = p2 = primes[0]
    while p1 == p2:
        p1, p2 = random.choice(primes), random.choice(primes)
    n = p1 * p2
    phi = (p1 - 1) * (p2 - 1)
    e = 9311
    while not are_coprime(e, phi): e += 2
    d = mod_inverse(e, phi)
    if d is None: raise ValueError("Could not compute modular inverse for d")
    return to_js({"n": str(n), "e": str(e), "d": str(d)})

def apply_padding(message_int: int, padding_digits: int) -> int:
    suffix = "".join(str(random.randrange(0, 10)) for _ in range(padding_digits))
    return int(f"{int(message_int)}{suffix}")

def remove_padding(message_int: int, padding_digits: int) -> int:
    text = str(int(message_int))
    if padding_digits <= 0: return int(text)
    if len(text) <= padding_digits: return 0
    return int(text[: len(text) - padding_digits])

def encrypt_int(message_int: int, n: int, e: int, padding_digits: int) -> int:
    padded = apply_padding(message_int, padding_digits)
    return mod_pow(padded, e, n)

def decrypt_int(cipher_int: int, n: int, d: int, padding_digits: int) -> int:
    padded = mod_pow(cipher_int, d, n)
    return remove_padding(padded, padding_digits)

def encrypt_string(text: str, n: int, e: int, padding_digits: int) -> List[int]:
    n_i, e_i, p_i = int(n), int(e), int(padding_digits)
    cypher = [encrypt_int(ord(ch), n_i, e_i, p_i) for ch in text]
    return to_js(cypher)  

def decrypt_string(cipher_list: List[int], n: int, d: int, padding_digits: int) -> str:
    n_i, d_i, p_i = int(n), int(d), int(padding_digits)
    chars = [chr(decrypt_int(int(c), n_i, d_i, p_i)) for c in cipher_list]
    return to_js("".join(chars))

window.py_generate_keys = generate_keys
window.py_encrypt_string = encrypt_string
window.py_decrypt_string = decrypt_string
window.python_is_ready = True
</script>

<script>
    const ws = new WebSocket("wss://rsa-encryption-r1nj.onrender.com");
    const chatHistoryDiv = document.getElementById("chat-history");
    
    // --- MULTI-CHAT STATE ---
    let activeChatId = 'global';
    let chatHistories = {
        'global': [`<div class="msg global">‚åõ Waiting for the Python engine (PyScript) to finish loading...</div>`]
    };

    let knownUsers = {}; 
    let amIOnline = false;
    let heartbeatTimer = null;
    let cleanupTimer = null;

    ws.onopen = () => {
        document.getElementById("ws-status").innerText = "üü¢";
    };

    function scrollToBottom() {
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
    }

    // Add a message to the right array and render it if it's the active tab
    function appendMsg(chatId, htmlString) {
        if (!chatHistories[chatId]) chatHistories[chatId] = [];
        chatHistories[chatId].push(htmlString);
        
        if (activeChatId === chatId) {
            chatHistoryDiv.innerHTML += htmlString;
            scrollToBottom();
        }
    }

    const checkPythonReady = setInterval(() => {
        if (window.python_is_ready) {
            clearInterval(checkPythonReady);
            document.getElementById("py-status").innerText = "Python Ready ‚úÖ";
            document.getElementById("py-status").style.background = "#1f3a28";
            document.getElementById("py-status").style.color = "#76c489";
            
            appendMsg('global', `<div class="msg global">‚úÖ Python loaded. Generating keys with your algorithm...</div>`);
            
            const keys = window.py_generate_keys(100, 500); 
            document.getElementById("my-n").value = keys.get("n");
            document.getElementById("my-e").value = keys.get("e");
            document.getElementById("my-d").value = keys.get("d");
            
            renderUserList(); // Render the Global Network initially
        }
    }, 500);

    function toggleOnlineStatus() {
        const myName = document.getElementById("my-name").value.trim() || "Anonymous";
        const myN = document.getElementById("my-n").value;
        const myE = document.getElementById("my-e").value;
        
        if (!myN || !myE) return alert("Wait for the keys to be generated.");
        
        if (!amIOnline) {
            amIOnline = true;
            document.getElementById("btn-announce").innerText = "Update name";
            document.getElementById("btn-announce").style.background = "#2b5278";
            
            appendMsg('global', `<div class="msg global">üì¢ You are now visible on the network as "${myName}".</div>`);

            sendPresence();
            heartbeatTimer = setInterval(sendPresence, 5000);
            cleanupTimer = setInterval(removeGhostUsers, 3000);
            
        } else {
            sendPresence();
            appendMsg('global', `<div class="msg global">üì¢ Profile updated to "${myName}".</div>`);
        }
    }

    function sendPresence() {
        const payload = {
            type: "presence",
            name: document.getElementById("my-name").value.trim() || "Anonymous",
            n: document.getElementById("my-n").value,
            e: document.getElementById("my-e").value
        };
        if (ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(payload));
    }

    function removeGhostUsers() {
        const now = Date.now();
        let changed = false;
        for (let n_key in knownUsers) {
            if (now - knownUsers[n_key].lastSeen > 12000) {
                delete knownUsers[n_key];
                changed = true;
                // If I was chatting with them, let me know
                appendMsg(n_key, `<div class="msg global">üîå The user has disconnected.</div>`);
            }
        }
        if (changed) renderUserList();
    }

    // --- RENDERING AND TAB SWITCHING ---
    function renderUserList() {
        const listDiv = document.getElementById("user-list");
        let html = '';
        
        // 1. Always first: Global tab
        const globalActive = activeChatId === 'global' ? 'active' : '';
        html += `
            <div class="user-card ${globalActive}" onclick="selectChat('global', 'Global P2P Network', '', '')">
                <div class="user-avatar" style="background: #17212b; border: 1px solid #5288c1;">üåê</div>
                <div class="user-info">
                    <div class="user-name">Global P2P Network</div>
                    <div class="user-n">Interception monitor</div>
                </div>
            </div>
        `;

        // 2. Then, real users
        const userKeys = Object.keys(knownUsers);
        document.getElementById("online-count").innerText = userKeys.length;

        userKeys.forEach(n_key => {
            const u = knownUsers[n_key];
            const initial = u.name.charAt(0).toUpperCase();
            const isActive = activeChatId === u.n ? 'active' : '';
            
            html += `
                <div class="user-card ${isActive}" onclick="selectChat('${u.n}', '${u.name}', '${u.n}', '${u.e}')">
                    <div class="user-avatar">
                        ${initial}
                        <div class="online-dot"></div>
                    </div>
                    <div class="user-info">
                        <div class="user-name">${u.name}</div>
                        <div class="user-n">n: ${u.n.substring(0,8)}...</div>
                    </div>
                </div>
            `;
        });
        
        listDiv.innerHTML = html;
    }

    // Switch between Global and a User
    window.selectChat = function(chatId, name, n, e) {
        activeChatId = chatId;
        document.getElementById('chat-title-text').innerHTML = `${name} <span id="ws-status" style="font-size: 12px; margin-left: 10px;">üü¢</span>`;
        
        if (chatId === 'global') {
            document.getElementById('chat-subtitle-text').innerText = 'Encrypted network traffic monitor';
            document.getElementById('message-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('message-input').placeholder = "Select a user to send messages...";
        } else {
            document.getElementById('chat-subtitle-text').innerText = `n: ${n.substring(0,8)}... e: ${e}`;
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('message-input').placeholder = `Secret message to ${name}...`;
            
            // Autocomplete hidden fields for compatibility
            document.getElementById('rec-n').value = n;
            document.getElementById('rec-e').value = e;
        }
        
        // Load that chat's history
        if (!chatHistories[chatId]) chatHistories[chatId] = [];
        chatHistoryDiv.innerHTML = chatHistories[chatId].join('');
        scrollToBottom();
        
        // Update active highlighting in the list
        renderUserList();
        if(chatId !== 'global') document.getElementById("message-input").focus();
    };

    function handleEnter(e) {
        if (e.key === 'Enter' && !document.getElementById('message-input').disabled) { 
            sendCustomMessage(); 
        }
    }

    function sendCustomMessage() {
        const recN = document.getElementById("rec-n").value.trim();
        const recE = document.getElementById("rec-e").value.trim();
        const text = document.getElementById("message-input").value;
        const p = document.getElementById("pad-p").value;
        const myName = document.getElementById("my-name").value.trim(); // No more "Anonymous"
        const myN = document.getElementById("my-n").value;
        const myE = document.getElementById("my-e").value;

        if (!myName) return alert("Please set a Public Name before sending messages.");
        if (!recN || !recE || !text) return alert("Recipient error or empty message.");
        const cipherArray = window.py_encrypt_string(text, recN, recE, p.toString());
        const serializedCipher = Array.from(cipherArray).join(" ");
        
        // IMPORTANT: The packet includes who sent it, so we can split it into chats
        const payload = {
            type: "message", 
            from_name: myName,
            from_n: myN,
            from_e: myE,
            to_n: recN,
            to_e: recE,
            data: serializedCipher
        };

        ws.send(JSON.stringify(payload));

        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Store it in the tab of the person I'm talking to
        appendMsg(recN, `<div class="msg sent">${text}<span class="msg-meta">${time}</span></div>`);
        
        // In my global console, log that I sent traffic
    appendMsg('global', `<div class="msg global" style="cursor: pointer; word-break: break-all;" onclick="this.innerText = 'üì¶ Full packet sent:\n' + '${serializedCipher}'" title="Click to expand">üì¶ You sent an encrypted packet to n:${recN.substring(0,5)}...</div>`);
        document.getElementById("message-input").value = "";
    }

    ws.onmessage = async (event) => {
        let dataStr = event.data instanceof Blob ? await event.data.text() : event.data;
        const packet = JSON.parse(dataStr);
        const myN = document.getElementById("my-n").value;
        const myE = document.getElementById("my-e").value;
        const myD = document.getElementById("my-d").value;
        
        if (packet.type === "presence") {
            if (packet.n !== myN) { 
                let isNewUser = !knownUsers[packet.n];
                knownUsers[packet.n] = { name: packet.name, n: packet.n, e: packet.e, lastSeen: Date.now() };
                if (isNewUser) renderUserList();
            }
            return; 
        }
        
        if (packet.type === "message") {
            const p = document.getElementById("pad-p").value;
            
            // If someone isn't in contacts but messages me, add them automatically
            if (packet.from_n !== myN && !knownUsers[packet.from_n]) {
                knownUsers[packet.from_n] = { name: packet.from_name || "Unknown", n: packet.from_n, e: packet.from_e, lastSeen: Date.now() };
                renderUserList();
            }

            if (packet.to_n === myN && packet.to_e === myE) {
                // MESSAGE IS FOR ME
                const cipherArray = packet.data.split(" ");
                try {
                    const decryptedText = window.py_decrypt_string(cipherArray, myN, myD, p.toString());
                    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Put it in the 1:1 chat of the sender
                    appendMsg(packet.from_n, `<div class="msg received">${decryptedText}<span class="msg-meta">${time}</span></div>`);
                    
                    // Notify in the global chat that I intercepted something meant for me
                    appendMsg('global', `<div class="msg global" style="color: #76c489;">üîì You decrypted a P2P packet addressed to you.</div>`);
                } catch (e) {
                    appendMsg(packet.from_n, `<div class="msg received" style="color: #ff8a8a;">[Error decrypting corrupt packet]</div>`);
                }
            } else {
                // NOT FOR ME: Regular P2P network traffic
appendMsg('global', `<div class="msg global" style="cursor: pointer; word-break: break-all;" onclick="this.innerText = 'üîí Full packet intercepted:\n' + '${packet.data}'" title="Click to expand">üîí Traffic intercepted for n:${packet.to_n.substring(0,5)}...</div>`);            }
        }
    };
</script>

</body>
</html>