<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSA Chat</title>
    <link rel="icon" href="media/logo.svg">
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        /* DARK THEME AND FULL SCREEN */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #0e1621; color: #f5f5f5; height: 100dvh; display: flex; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3a4b5c; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5288c1; }
        ::-webkit-scrollbar-corner { background: transparent; }
        
        .app-container { display: flex; width: 100vw; height: 100dvh; background: #0e1621; }
        .sidebar { width: 350px; background: #17212b; border-right: 1px solid #000; display: flex; flex-direction: column; z-index: 2; flex-shrink: 0; }
        .sidebar-header { background: #17212b; height: 68px; padding: 0 20px; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: space-between; gap: 10px; border-bottom: 1px solid #000; box-sizing: border-box; }
        .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; }
        
        .section-title { font-size: 13px; color: #5288c1; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 15px; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 13px; color: #7a8b9a; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid transparent; border-radius: 8px; font-family: monospace; font-size: 14px; background: #242f3d; color: #fff; outline: none; transition: border 0.2s; }
        .input-group input:focus { border-color: #5288c1; }
        .input-group input.private-key { color: #ff8a8a; }
        .divider { height: 1px; background: #000; margin: 15px 0; }
        
        /* Contact list */
        .user-list { display: flex; flex-direction: column; gap: 5px; }
        .user-card { background: transparent; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 10px; position: relative;}
        .user-card:hover { background: #242f3d; }
        .user-card.active { background: #2b5278; }
        .user-avatar { width: 40px; height: 40px; background: #5288c1; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; color: white; position: relative; font-size: 16px; flex-shrink: 0; line-height: 1; padding-bottom: 2px; padding-left: 2px;}
        .online-dot { width: 12px; height: 12px; background: #76c489; border: 2px solid #242f3d; border-radius: 50%; position: absolute; bottom: -2px; right: -2px; }
        .user-info { flex: 1; overflow: hidden; }
        .user-name { font-weight: bold; font-size: 15px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; color: #fff; }
        .user-n { font-size: 12px; color: #7aa1c9; font-family: monospace; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; margin-top: 2px; }
        .user-card.active .user-n { color: #a1c8ed; }

        .btn-announce { width: 100%; padding: 10px; background: #5288c1; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; transition: background 0.3s; }
        .btn-announce:hover { background: #4676a9; }

        /* Educational Banner */
        .edu-banner { background: #2b3a4a; border-radius: 12px; padding: 12px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; cursor: pointer; transition: background 0.2s; }
        .edu-banner:hover { background: #35475a; }
        .edu-banner-content { flex: 1; }
        .edu-banner-title { font-weight: bold; font-size: 15px; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .edu-banner-subtitle { font-size: 13px; color: #9aaebd; line-height: 1.4; }
        .edu-banner-close { color: #7a8b9a; cursor: pointer; padding: 2px; line-height: 1; font-size: 16px; transition: color 0.2s; }
        .edu-banner-close:hover { color: #fff; }
        
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #0e1621; position: relative; }
        .chat-area::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M0 0h20v20H0V0zm10 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" fill="%23ffffff" fill-opacity="0.02" fill-rule="evenodd"/%3E%3C/svg%3E'); z-index: 0; }
        
        .chat-header { background: #17212b; height: 68px; padding: 0 20px; border-bottom: 1px solid #000; display: flex; flex-direction: row; align-items: center; justify-content: space-between; z-index: 1; box-sizing: border-box; }
        .chat-header-info { display: flex; flex-direction: column; justify-content: center; }
        .chat-header-left { display: flex; flex-direction: row; align-items: center; }
        .chat-title { font-weight: bold; font-size: 16px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .chat-subtitle { font-size: 13px; color: #7a8b9a; margin-top: 2px; }
        
        .github-link { color: #7a8b9a; transition: color 0.2s; display: flex; align-items: center; }
        .github-link:hover { color: #fff; }
        
        .chat-history { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; z-index: 1; }
        
        /* Burbujas */
        .msg { max-width: 65%; padding: 8px 12px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .msg.sent { align-self: flex-end; background: #2b5278; border-radius: 12px 12px 4px 12px; color: #fff; }
        .msg.received { align-self: flex-start; background: #182533; border-radius: 12px 12px 12px 4px; color: #fff; }
        .msg.global { align-self: center; background: rgba(0,0,0,0.3); color: #7a8b9a; font-size: 12px; font-family: monospace; border-radius: 16px; box-shadow: none; text-align: center; max-width: 80%; padding: 6px 14px; }
        .msg-meta { font-size: 11px; color: #7aa1c9; text-align: right; margin-top: 4px; float: right; margin-left: 10px; }
        .msg.received .msg-meta { color: #5b7185; }
        
        .chat-input-area { background: #17212b; padding: 10px 20px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); display: flex; gap: 10px; align-items: center; z-index: 1; }
        .chat-input-area input { flex: 1; border: none; outline: none; font-size: 15px; padding: 12px; background: #242f3d; color: white; border-radius: 8px; }
        .btn-send { background: #5288c1; color: white; border: none; border-radius: 50%; width: 46px; height: 46px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
        .btn-send:hover { background: #4676a9; }
        .btn-send svg { width: 20px; height: 20px; fill: currentColor; margin-left: 4px; }
        .btn-send:disabled { background: #3b4b5c; color: #7a8b9a; cursor: not-allowed; }
        
        .my-avatar-btn {
            width: 32px; height: 32px; background: #242f3d; border-radius: 50%;
            display: none; justify-content: center; align-items: center;
            cursor: pointer; font-size: 16px; transition: background 0.2s;
            color: #fff; font-weight: bold; border: 1px solid #000; flex-shrink: 0;
            line-height: 1; padding-bottom: 2px; padding-left: 2px;
        }
        .my-avatar-btn:hover { background: #3b4b5c; }
        
        /* Modal Info/Profile */
        .modal-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #17212b; padding: 25px; border-radius: 12px; border: 1px solid #000;
            width: 380px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-weight: bold; font-size: 16px; color: #5288c1; text-transform: uppercase; letter-spacing: 0.5px; }
        .close-btn { cursor: pointer; color: #7a8b9a; font-size: 20px; transition: color 0.2s; line-height: 1; margin-top: -5px; }
        .close-btn:hover { color: #fff; }
        
        #py-status { width: 22px; height: 22px; border: 2.5px solid rgba(255,255,255,0.1); border-left-color: #5288c1; border-radius: 50%; animation: spin 1s linear infinite; flex-shrink: 0; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Media Queries for Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: 100dvh; flex-shrink: 0; }
            .chat-area { width: 100%; height: 100dvh; display: none; position: absolute; z-index: 10; top: 0; left: 0; }
            
            /* When chat is active on mobile */
            .app-container.chat-active .sidebar { display: none; }
            .app-container.chat-active .chat-area { display: flex; }
            
            .back-btn { display: flex !important; }
        }

        .back-btn { 
            display: none; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            color: #5288c1; 
            padding: 5px;
            margin-left: -10px;
            margin-right: 10px;
        }
        .back-btn:hover { color: #4676a9; }
        .back-btn svg { width: 32px; height: 32px; }
    </style>
</head>
<body>

<div class="app-container">

<div class="modal-overlay" id="profile-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Settings</div>
            <div class="close-btn" onclick="closeProfileModal()">‚úñ</div>
        </div>
        <div id="modal-inner-content">
            <!-- Form will be moved here dynamically when going online -->
        </div>
    </div>
</div>

<div class="modal-overlay" id="how-modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <div class="modal-title">How does it work? üìö</div>
            <div class="close-btn" onclick="closeHowModal()">‚úñ</div>
        </div>
        <div style="padding: 20px; font-size: 14px; line-height: 1.5; color: #f5f5f5; text-align: left; max-height: 70vh; overflow-y: auto;">
            
            <p style="color: #76c489; font-size: 16px; margin-bottom: 8px;"><strong>1. Hub-and-Spoke Architecture</strong></p>
            <p style="margin-bottom: 20px;">A central WebSocket relay (Bun server) simply bounces your traffic across the wire. It does <b>not</b> store passwords, keys, or messages. When you connect, you subscribe to a single global channel with everyone else. Everything you send is broadcasted publically to the room. This makes it an End-to-End Encrypted (E2EE) messaging system utilizing a central Relay rather than a true Peer-To-Peer network.</p>
            
            <p style="color: #5288c1; font-size: 16px; margin-bottom: 8px;"><strong>2. RSA Mathematics & Key Generation</strong></p>
            <p style="margin-bottom: 10px;">Cryptography relies on the computational difficulty of factoring large numbers. When you create a user, PyScript runs this logic locally in your browser:</p>
            <ul style="padding-left: 20px; margin-bottom: 20px; background: #17212b; padding: 15px 15px 15px 35px; border-radius: 8px;">
                <li style="margin-bottom: 5px;">Pick two prime numbers, <i>p</i> and <i>q</i>.</li>
                <li style="margin-bottom: 5px;">Compute the public modulus <strong><i>n</i> = <i>p</i> &times; <i>q</i></strong>.</li>
                <li style="margin-bottom: 5px;">Calculate Euler's Totient function: <strong>&phi;(<i>n</i>) = (<i>p</i>-1)(<i>q</i>-1)</strong>.</li>
                <li style="margin-bottom: 5px;">Choose a public exponent <strong><i>e</i></strong> that is coprime to &phi;(<i>n</i>).</li>
                <li>Find the private decryption exponent <strong><i>d</i></strong> by calculating the modular inverse: <strong><i>d</i> &equiv; <i>e</i><sup>-1</sup> (mod &phi;(<i>n</i>))</strong>.</li>
            </ul>
            <p style="margin-bottom: 20px;"><em>Public Key:</em> (<i>n</i>, <i>e</i>) is announced to the world. <br><em>Private Key:</em> (<i>d</i>) stays perfectly secret inside your browser memory.</p>
            
            <p style="color: #c4b576; font-size: 16px; margin-bottom: 8px;"><strong>3. The Magic: Euler's Theorem</strong></p>
            <p style="margin-bottom: 10px;">To encrypt a character payload <i>m</i> into a ciphertext <i>c</i>, Python does: <br><strong style="margin-left:20px; color: #fff;"><i>c</i> &equiv; <i>m</i><sup><i>e</i></sup> (mod <i>n</i>)</strong></p>
            <p style="margin-bottom: 10px;">To decrypt <i>c</i> back to the character: <br><strong style="margin-left:20px; color: #fff;"><i>m</i> &equiv; <i>c</i><sup><i>d</i></sup> (mod <i>n</i>)</strong></p>
            <p style="margin-bottom: 20px; background: #242f3d; padding: 10px; border-radius: 6px; font-style: italic;">This works perfectly because <i>c</i><sup><i>d</i></sup> &equiv; (<i>m</i><sup><i>e</i></sup>)<sup><i>d</i></sup> &equiv; <i>m</i><sup><i>e&middot;d</i></sup> (mod <i>n</i>). Since <i>e &middot; d</i> &equiv; 1 (mod &phi;(<i>n</i>)), Euler's theorem guarantees that the math wraps seamlessly back to the original message <i>m</i>.</p>

            <p style="color: #c47676; font-size: 16px; margin-bottom: 8px;"><strong>4. Messaging Interception</strong></p>
            <p>Because the ciphertext is broadcasted to the entire WebSocket room, anyone can intercept it (as seen in your "Global Hub Network" tab). However, since only the recipient has the mathematically linked private key (<i>d</i>) that fits that equation, only their browser can decrypt the payload into readable text. For everyone else, it remains cryptographic noise.</p>
        </div>
    </div>
</div>
    <div class="sidebar">
        <div class="sidebar-header">
            <span style="display: flex; align-items: center; gap: 20px; font-size: 26px;">
                <img src="media/logo.svg" width="32" height="32" alt="Logo">
                <span style="margin-top: -4px;">RSA Chat</span>
            </span>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="py-status" title="Loading Python engine..."></div>
                <div id="my-avatar-btn" class="my-avatar-btn" onclick="openProfileModal()"></div>
            </div>
        </div>
        <div class="sidebar-content" id="sidebar-content-area">
            <div id="profile-sidebar-section">
                <div class="section-title" style="margin-top: 0;">My Public Profile</div>
                <div class="input-group">
                    <input type="text" id="my-name" placeholder="Type your public name..." style="font-family: inherit; font-size: 15px; font-weight: bold;">
                    <button id="btn-announce" class="btn-announce" onclick="toggleOnlineStatus()">Create user</button>
                </div>

                <details style="margin-bottom: 15px;">
                    <summary style="color: #7a8b9a; font-size: 13px; cursor: pointer; margin-bottom: 5px;">Show my generated RSA keys</summary>
                    <div class="input-group" style="margin-top: 10px;">
                        <label>Public Key 'n'</label>
                        <input type="text" id="my-n" readonly placeholder="Waiting for Python...">
                    </div>
                    <div class="input-group">
                        <label>Public Key 'e'</label>
                        <input type="text" id="my-e" readonly placeholder="Waiting for Python...">
                    </div>
                    <div class="input-group">
                        <label>Private Key 'd'</label>
                        <input type="text" id="my-d" class="private-key" readonly placeholder="Waiting for Python...">
                    </div>
                </details>
                
                <details style="margin-bottom: 15px;">
                    <summary style="color: #7a8b9a; font-size: 13px; cursor: pointer;">Advanced Settings (Manual Recipient)</summary>
                    <div class="input-group" style="margin-top: 10px;">
                        <input type="text" id="rec-n" placeholder="Recipient n">
                    </div>
                    <div class="input-group">
                        <input type="text" id="rec-e" placeholder="Recipient e">
                    </div>
                    <div class="input-group">
                        <label>Global padding 'p'</label>
                        <input type="number" id="pad-p" value="0">
                    </div>
                </details>
                <div class="divider"></div>
            </div>
            
            <div class="section-title" style="margin-top: 0;">Chats <span id="online-count" style="float: right; color: #76c489;"></span></div>
            <div id="user-list" class="user-list">
                </div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-header-left">
                <div class="back-btn" onclick="showSidebar()" title="Back to chats">
                    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </div>
                <div class="chat-header-info">
                    <div class="chat-title" id="chat-title-text">Global Hub Network <span id="ws-status" style="font-size: 12px; margin-left: 10px;">üî¥</span></div>
                    <div class="chat-subtitle" id="chat-subtitle-text">Encrypted network traffic monitor</div>
                </div>
            </div>
            <a href="https://github.com/pepert03/rsa-encryption" target="_blank" class="github-link" title="View Source on GitHub">
                <svg height="24" width="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
        </div>
        
        <div class="chat-history" id="chat-history">
            </div>
        
        <div class="chat-input-area">
            <input type="text" id="message-input" placeholder="Select a user to send messages..." onkeypress="handleEnter(event)" disabled>
            <button id="send-btn" class="btn-send" onclick="sendCustomMessage()" title="Send" disabled>
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </div>
    </div>
</div>

<script type="py">
import random
from math import isqrt
from typing import List, Optional, Tuple
from js import window
from pyodide.ffi import to_js

def bezout(a: int, b: int) -> Tuple[int, int, int]:
    if a == 0 and b == 0: return 0, 0, 0
    old_r, r = a, b
    old_x, x = 1, 0
    old_y, y = 0, 1
    while r != 0:
        q = old_r // r
        old_r, r = r, old_r - q * r
        old_x, x = x, old_x - q * x
        old_y, y = y, old_y - q * y
    return int(old_r), int(old_x), int(old_y)

def mod_inverse(value: int, modulus: int) -> Optional[int]:
    g, x, _y = bezout(value, modulus)
    if g != 1: return None
    return x % modulus

def mod_pow(base: int, exponent: int, modulus: int) -> int:
    if modulus == 0: raise ValueError("modulus must be non-zero")
    if exponent < 0:
        base = mod_inverse(base, modulus)
        if base is None: raise ValueError("base has no modular inverse for negative exponent")
        exponent = -exponent
    return pow(base % modulus, exponent, modulus)

def gcd(a: int, b: int) -> int:
    x, y = abs(a), abs(b)
    while y != 0: x, y = y, x % y
    return x

def are_coprime(a: int, b: int) -> bool:
    return gcd(a, b) == 1

def is_prime(n: int) -> bool:
    if n < 2: return False
    if n == 2: return True
    if n % 2 == 0: return False
    limit = isqrt(n)
    for candidate in range(3, limit + 1, 2):
        if n % candidate == 0: return False
    return True

def list_primes(start: int, end: int) -> List[int]:
    if end <= 2: return []
    sieve = [1 for _ in range(end)]
    sieve[0] = 0
    if end > 1: sieve[1] = 0
    limit = int(end**0.5)
    candidate = 2
    while candidate <= limit:
        if sieve[candidate] == 0:
            candidate += 1
            continue
        multiple = candidate * 2
        while multiple < end:
            sieve[multiple] = 0
            multiple += candidate
        candidate += 1
    primes: List[int] = []
    for value in range(max(2, start), end):
        if sieve[value] == 1: primes.append(value)
    return primes

def generate_keys(min_prime: int, max_prime: int) -> Tuple[int, int, int]:
    primes = list_primes(min_prime, max_prime)
    p1 = p2 = primes[0]
    while p1 == p2:
        p1, p2 = random.choice(primes), random.choice(primes)
    n = p1 * p2
    phi = (p1 - 1) * (p2 - 1)
    e = 9311
    while not are_coprime(e, phi): e += 2
    d = mod_inverse(e, phi)
    if d is None: raise ValueError("Could not compute modular inverse for d")
    return to_js({"n": str(n), "e": str(e), "d": str(d)})

def apply_padding(message_int: int, padding_digits: int) -> int:
    suffix = "".join(str(random.randrange(0, 10)) for _ in range(padding_digits))
    return int(f"{int(message_int)}{suffix}")

def remove_padding(message_int: int, padding_digits: int) -> int:
    text = str(int(message_int))
    if padding_digits <= 0: return int(text)
    if len(text) <= padding_digits: return 0
    return int(text[: len(text) - padding_digits])

def encrypt_int(message_int: int, n: int, e: int, padding_digits: int) -> int:
    padded = apply_padding(message_int, padding_digits)
    return mod_pow(padded, e, n)

def decrypt_int(cipher_int: int, n: int, d: int, padding_digits: int) -> int:
    padded = mod_pow(cipher_int, d, n)
    return remove_padding(padded, padding_digits)

def encrypt_string(text: str, n: int, e: int, padding_digits: int) -> List[int]:
    n_i, e_i, p_i = int(n), int(e), int(padding_digits)
    cypher = [encrypt_int(ord(ch), n_i, e_i, p_i) for ch in text]
    return to_js(cypher)  

def decrypt_string(cipher_list: List[int], n: int, d: int, padding_digits: int) -> str:
    n_i, d_i, p_i = int(n), int(d), int(padding_digits)
    chars = [chr(decrypt_int(int(c), n_i, d_i, p_i)) for c in cipher_list]
    return to_js("".join(chars))

window.py_generate_keys = generate_keys
window.py_encrypt_string = encrypt_string
window.py_decrypt_string = decrypt_string
window.python_is_ready = True
</script>

<script>
    const ws = new WebSocket("wss://rsa-encryption-r1nj.onrender.com");
    const chatHistoryDiv = document.getElementById("chat-history");
    
    // --- MULTI-CHAT STATE ---
    let activeChatId = 'global';
    let chatHistories = {
        'global': [`<div class="msg global">‚åõ Waiting for the Python engine (PyScript) to finish loading...</div>`]
    };

    let knownUsers = {}; 
    let amIOnline = false;
    let heartbeatTimer = null;
    let cleanupTimer = null;
    let showEduBanner = true; // State for the educational banner

    // LOCAL STORAGE FUNCTIONS
    function saveToLocalStorage() {
        const myName = document.getElementById("my-name").value;
        const myN = document.getElementById("my-n").value;
        const myE = document.getElementById("my-e").value;
        const myD = document.getElementById("my-d").value;
        
        // Filter knownUsers: only save those with whom we have a chat history
        const usersToSave = {};
        for (const n_key in knownUsers) {
            if (chatHistories[n_key] && chatHistories[n_key].length > 0) {
                usersToSave[n_key] = knownUsers[n_key];
            }
        }

        const data = {
            name: myName, n: myN, e: myE, d: myD,
            histories: chatHistories,
            knownUsers: usersToSave
        };
        localStorage.setItem("rsaChatData", JSON.stringify(data));
    }

    function loadFromLocalStorage() {
        const stored = localStorage.getItem("rsaChatData");
        if (stored) {
            try {
                const data = JSON.parse(stored);
                // Restore profile
                if (data.name) document.getElementById("my-name").value = data.name;
                if (data.n) document.getElementById("my-n").value = data.n;
                if (data.e) document.getElementById("my-e").value = data.e;
                if (data.d) document.getElementById("my-d").value = data.d;
                
                // Restore histories
                if (data.histories) {
                    chatHistories = data.histories;
                    // Ensure global still has python waiting if it wasn't there
                    if (!chatHistories['global']) chatHistories['global'] = [];
                }
                
                // Restore knownUsers
                if (data.knownUsers) {
                    knownUsers = data.knownUsers;
                    for (let k in knownUsers) {
                        knownUsers[k].online = false; // Everyone starts offline
                    }
                }
            } catch (e) {
                console.error("Error loading local storage", e);
            }
        }
    }
    
    // Load data immediately
    loadFromLocalStorage();

    ws.onopen = () => {
        document.getElementById("ws-status").innerText = "üü¢";
    };

    function scrollToBottom() {
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
    }

// Add a message to the right array and render it if it's the active tab
    function appendMsg(chatId, htmlString) {
        if (!chatHistories[chatId]) chatHistories[chatId] = [];
        chatHistories[chatId].push(htmlString);
        
        if (activeChatId === chatId) {
            chatHistoryDiv.innerHTML += htmlString;
            scrollToBottom();
        }
        saveToLocalStorage();
    }

    // Modal behavior
    function openProfileModal() {
        document.getElementById("profile-modal").style.display = "flex";
    }
    function closeProfileModal() {
        document.getElementById("profile-modal").style.display = "none";
    }

    function openHowModal() {
        document.getElementById("how-modal").style.display = "flex";
    }
    function closeHowModal() {
        document.getElementById("how-modal").style.display = "none";
    }
    
    function dismissEduBanner(event) {
        event.stopPropagation(); // prevent clicking the banner itself
        showEduBanner = false;
        renderUserList();
    }

    const checkPythonReady = setInterval(() => {
        if (window.python_is_ready) {
            clearInterval(checkPythonReady);
            document.getElementById("py-status").style.display = "none";
            
            appendMsg('global', `<div class="msg global">‚úÖ Python loaded. Ready!</div>`);
            
            // If they already have keys loaded from localStorage, don't clear them
            if (!document.getElementById("my-n").value) {
                document.getElementById("my-n").placeholder = "Will be generated...";
                document.getElementById("my-e").placeholder = "Will be generated...";
                document.getElementById("my-d").placeholder = "Will be generated...";
            } else {
                // If they have keys, automatically restore their online session
                appendMsg('global', `<div class="msg global">üîÑ Found existing profile for "${document.getElementById("my-name").value}". Restoring session...</div>`);
                toggleOnlineStatus();
            }
            
            renderUserList(); // Render the Global Network initially
            
            // Show the loaded global history
            chatHistoryDiv.innerHTML = chatHistories['global'].join('');
            scrollToBottom();
        }
    }, 500);

    function toggleOnlineStatus() {
        if (!window.python_is_ready) return alert("Wait for Python to load.");
        
        const myName = document.getElementById("my-name").value.trim();
        
        if (!amIOnline) {
            if (!myName) return alert("Please enter a public name first.");
            
            // Generate keys now if missing
            if (!document.getElementById("my-n").value) {
                appendMsg('global', `<div class="msg global">‚åõ Generating RSA keys...</div>`);
                const keys = window.py_generate_keys(100, 500); 
                document.getElementById("my-n").value = keys.get("n");
                document.getElementById("my-e").value = keys.get("e");
                document.getElementById("my-d").value = keys.get("d");
            }
            
            amIOnline = true;
            document.getElementById("btn-announce").innerText = "Delete user";
            document.getElementById("btn-announce").style.background = "#cc4b4b"; // Reddish for delete!
            
            // Move content to modal and hide from sidebar
            const profileSection = document.getElementById("profile-sidebar-section");
            document.getElementById("modal-inner-content").appendChild(profileSection);
            
            // Show avatar next to chat title
            const avatarBtn = document.getElementById("my-avatar-btn");
            avatarBtn.style.display = "flex";
            avatarBtn.innerText = myName.charAt(0).toUpperCase();
            avatarBtn.style.background = "#5288c1";
            
            appendMsg('global', `<div class="msg global">üì¢ You are now visible on the network as "${myName}".</div>`);

            saveToLocalStorage(); // Save that we generated keys

            sendPresence();
            heartbeatTimer = setInterval(sendPresence, 1000);
            cleanupTimer = setInterval(removeGhostUsers, 3000);
            
            closeProfileModal();
        } else {
            // Delete user logic
            amIOnline = false;
            clearInterval(heartbeatTimer);
            clearInterval(cleanupTimer);

            // Broadcast account deletion to network so peers delete the conversations
            if (ws.readyState === WebSocket.OPEN && document.getElementById("my-n").value) {
                ws.send(JSON.stringify({
                    type: "delete_account",
                    n: document.getElementById("my-n").value
                }));
            }

            document.getElementById("my-n").value = "";
            document.getElementById("my-e").value = "";
            document.getElementById("my-d").value = "";
            document.getElementById("my-name").value = "";
            
            document.getElementById("btn-announce").innerText = "Create user";
            document.getElementById("btn-announce").style.background = "#5288c1";
            
            // Move content back to sidebar
            const profileSection = document.getElementById("profile-sidebar-section");
            document.getElementById("sidebar-content-area").prepend(profileSection);
            
            // Hide avatar
            document.getElementById("my-avatar-btn").style.display = "none";
            
            // Wipe chats and contacts
            chatHistories = {
                'global': [`<div class="msg global">‚úÖ Python loaded. Ready!</div>`]
            };
            knownUsers = {};
            selectChat('global', 'Global Hub Network', '', '');
            saveToLocalStorage();
            
            appendMsg('global', `<div class="msg global">ÔøΩ You have disconnected and deleted your user profile.</div>`);
            
            closeProfileModal();
        }
    }

    function sendPresence() {
        const payload = {
            type: "presence",
            name: document.getElementById("my-name").value.trim() || "Anonymous",
            n: document.getElementById("my-n").value,
            e: document.getElementById("my-e").value
        };
        if (ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(payload));
    }

    function removeGhostUsers() {
        const now = Date.now();
        let changed = false;
        for (let n_key in knownUsers) {
            if (knownUsers[n_key].online && (now - knownUsers[n_key].lastSeen > 12000)) {
                knownUsers[n_key].online = false;
                changed = true;
                // If I was chatting with them, let me know
                appendMsg(n_key, `<div class="msg global">üîå The user has disconnected.</div>`);
                saveToLocalStorage();
            }
        }
        if (changed) renderUserList();
    }

    // --- RENDERING AND TAB SWITCHING ---
    function renderUserList() {
        const listDiv = document.getElementById("user-list");
        let html = '';
        
        // 0. Educational Banner
        if (showEduBanner) {
            html += `
                <div class="edu-banner" onclick="openHowModal()">
                    <div class="edu-banner-content">
                        <div class="edu-banner-title">How does it work? üìö</div>
                        <div class="edu-banner-subtitle">Learn the math (Euler's Theorem) & E2EE architecture behind RSA.</div>
                    </div>
                    <div class="edu-banner-close" onclick="dismissEduBanner(event)">‚úï</div>
                </div>
            `;
        }
        
        // 1. Always first: Global tab
        const globalActive = activeChatId === 'global' ? 'active' : '';
        html += `
            <div class="user-card ${globalActive}" onclick="selectChat('global', 'Global Hub Network', '', '')">
                <div class="user-avatar" style="background: #17212b; border: 1px solid #5288c1;">üåê</div>
                <div class="user-info">
                    <div class="user-name">Global Hub Network</div>
                    <div class="user-n">Interception monitor</div>
                </div>
            </div>
        `;

        // 2. Then, real users
        const userKeys = Object.keys(knownUsers);
        let onlineCount = 0;
        userKeys.forEach(k => { if (knownUsers[k].online) onlineCount++; });
        document.getElementById("online-count").innerText = onlineCount;

        userKeys.forEach(n_key => {
            const u = knownUsers[n_key];
            const initial = u.name.charAt(0).toUpperCase();
            const isActive = activeChatId === u.n ? 'active' : '';
            const dotColor = u.online ? '#76c489' : 'transparent';
            const dotBorder = u.online ? '2px solid #242f3d' : 'none';
            
            html += `
                <div class="user-card ${isActive}" onclick="selectChat('${u.n}', '${u.name}', '${u.n}', '${u.e}')">
                    <div class="user-avatar">
                        ${initial}
                        <div class="online-dot" style="background: ${dotColor}; border: ${dotBorder};"></div>
                    </div>
                    <div class="user-info">
                        <div class="user-name">${u.name}</div>
                        <div class="user-n">n: ${u.n}</div>
                    </div>
                </div>
            `;
        });
        
        listDiv.innerHTML = html;
    }

    // Switch between Global and a User
    window.selectChat = function(chatId, name, n, e) {
        activeChatId = chatId;
        document.getElementById('chat-title-text').innerHTML = `${name} <span id="ws-status" style="font-size: 12px; margin-left: 10px;">üü¢</span>`;
        
        if (chatId === 'global') {
            document.getElementById('chat-subtitle-text').innerText = 'Encrypted network traffic monitor';
            document.getElementById('message-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('message-input').placeholder = "Select a user to send messages...";
        } else {
            document.getElementById('chat-subtitle-text').innerText = `n: ${n} e: ${e}`;
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('message-input').placeholder = `Secret message to ${name}...`;
            
            // Autocomplete hidden fields for compatibility
            document.getElementById('rec-n').value = n;
            document.getElementById('rec-e').value = e;
        }
        
        // Load that chat's history
        if (!chatHistories[chatId]) chatHistories[chatId] = [];
        chatHistoryDiv.innerHTML = chatHistories[chatId].join('');
        scrollToBottom();
        
        // Update active highlighting in the list
        renderUserList();
        if(chatId !== 'global') document.getElementById("message-input").focus();

        // Mobile responsiveness: Show chat area and hide sidebar
        if (window.innerWidth <= 768) {
            document.querySelector('.app-container').classList.add('chat-active');
            
            // Push history state to intercept the hardware back button
            if (!history.state || history.state.chatOpen !== chatId) {
                history.pushState({ chatOpen: chatId }, "", "#chat-" + chatId);
            }
        }
    };

    window.showSidebar = function(fromHistory = false) {
        document.querySelector('.app-container').classList.remove('chat-active');
        // If the user clicked the HTML back button, we should also pop the history 
        // to keep the browser state in sync with the visual state.
        if (!fromHistory && history.state && history.state.chatOpen) {
            history.back();
        }
    };

    // Listen to hardware/browser back buttons
    window.addEventListener('popstate', (event) => {
        // If we are on mobile and the chat is active, popstate means we went "back" out of the chat
        if (window.innerWidth <= 768) {
            if (!event.state || !event.state.chatOpen) {
                // Return to sidebar visual state
                window.showSidebar(true);
            }
        }
    });

    function handleEnter(e) {
        if (e.key === 'Enter' && !document.getElementById('message-input').disabled) { 
            sendCustomMessage(); 
        }
    }

    function sendCustomMessage() {
        const recN = document.getElementById("rec-n").value.trim();
        const recE = document.getElementById("rec-e").value.trim();
        const text = document.getElementById("message-input").value;
        const p = document.getElementById("pad-p").value;
        const myName = document.getElementById("my-name").value.trim(); // No more "Anonymous"
        const myN = document.getElementById("my-n").value;
        const myE = document.getElementById("my-e").value;

        if (!myName) return alert("Please set a Public Name before sending messages.");
        if (!recN || !recE || !text) return alert("Recipient error or empty message.");
        const cipherArray = window.py_encrypt_string(text, recN, recE, p.toString());
        const serializedCipher = Array.from(cipherArray).join(" ");
        
        // Add to knownUsers if not exists
        if (!knownUsers[recN]) {
            knownUsers[recN] = { name: "Manual Contact", n: recN, e: recE, lastSeen: Date.now(), online: false };
            renderUserList();
            saveToLocalStorage();
        }

        // IMPORTANT: The packet includes who sent it, so we can split it into chats
        const payload = {
            type: "message", 
            from_name: myName,
            from_n: myN,
            from_e: myE,
            to_n: recN,
            to_e: recE,
            data: serializedCipher
        };

        ws.send(JSON.stringify(payload));

        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Store it in the tab of the person I'm talking to
        appendMsg(recN, `<div class="msg sent">${text}<span class="msg-meta">${time}</span></div>`);
        
        // In my global console, log that I sent traffic
        appendMsg('global', `<div class="msg global" style="cursor: pointer; word-break: break-all;" onclick="this.innerText = 'üì¶ Full packet sent:\\n' + '${serializedCipher}'" title="Click to expand">üì¶ You sent an encrypted packet to n:${recN}</div>`);
        document.getElementById("message-input").value = "";
    }

    ws.onmessage = async (event) => {
        let dataStr = event.data instanceof Blob ? await event.data.text() : event.data;
        const packet = JSON.parse(dataStr);
        const myN = document.getElementById("my-n").value;
        const myE = document.getElementById("my-e").value;
        const myD = document.getElementById("my-d").value;
        
        if (packet.type === "delete_account") {
            const deletedN = packet.n;
            if (knownUsers[deletedN] || chatHistories[deletedN]) {
                delete knownUsers[deletedN];
                delete chatHistories[deletedN];
                
                if (activeChatId === deletedN) {
                    selectChat('global', 'Global E2EE Network', '', '');
                } else {
                    renderUserList();
                }
                saveToLocalStorage();
                appendMsg('global', `<div class="msg global" style="color: #ff8a8a;">üóëÔ∏è User (n:${deletedN}) deleted their account. Conversations wiped.</div>`);
            }
            return;
        }

        if (packet.type === "presence") {
            if (packet.n !== myN) { 
                let isNewUser = !knownUsers[packet.n];
                if (isNewUser) {
                    knownUsers[packet.n] = { name: packet.name, n: packet.n, e: packet.e, lastSeen: Date.now(), online: true };
                    renderUserList();
                    saveToLocalStorage();
                } else {
                    knownUsers[packet.n].name = packet.name; // Update name in case it changed
                    knownUsers[packet.n].lastSeen = Date.now();
                    if (!knownUsers[packet.n].online) {
                        knownUsers[packet.n].online = true;
                        renderUserList();
                        saveToLocalStorage();
                    }
                }
            }
            return; 
        }
        
        if (packet.type === "message") {
            const p = document.getElementById("pad-p").value;
            
            // If someone isn't in contacts but messages me, add them automatically
            if (packet.from_n !== myN) {
                if (!knownUsers[packet.from_n]) {
                    knownUsers[packet.from_n] = { name: packet.from_name || "Unknown", n: packet.from_n, e: packet.from_e, lastSeen: Date.now(), online: true };
                    renderUserList();
                    saveToLocalStorage();
                } else {
                    knownUsers[packet.from_n].lastSeen = Date.now();
                    if (!knownUsers[packet.from_n].online) {
                        knownUsers[packet.from_n].online = true;
                        renderUserList();
                        saveToLocalStorage();
                    }
                }
            }

            if (packet.to_n === myN && packet.to_e === myE) {
                // MESSAGE IS FOR ME
                const cipherArray = packet.data.split(" ");
                try {
                    const decryptedText = window.py_decrypt_string(cipherArray, myN, myD, p.toString());
                    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Put it in the 1:1 chat of the sender
                    appendMsg(packet.from_n, `<div class="msg received">${decryptedText}<span class="msg-meta">${time}</span></div>`);
                    
                    // Notify in the global chat that I intercepted something meant for me
                    appendMsg('global', `<div class="msg global" style="color: #76c489;">üîì You decrypted an E2EE packet addressed to you.</div>`);
                } catch (e) {
                    appendMsg(packet.from_n, `<div class="msg received" style="color: #ff8a8a;">[Error decrypting corrupt packet]</div>`);
                }
            } else {
                // NOT FOR ME: Regular Relay network traffic
                appendMsg('global', `<div class="msg global" style="cursor: pointer; word-break: break-all;" onclick="this.innerText = 'üîí Full packet intercepted:\\n' + '${packet.data}'" title="Click to expand">üîí Traffic intercepted for n:${packet.to_n}</div>`);            }
        }
    };
</script>

</body>
</html>